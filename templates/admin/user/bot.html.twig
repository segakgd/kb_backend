{% extends 'base.html.twig' %}

{% block title %}Дашборд{% endblock %}

{% block main %}

    <div class="container">
        <div class="row">
            <div class="col-7">
                <div class="wrapper--block">
                    <div class="admin--title--wrapper">
                        <h2>Бот</h2>
                    </div>

                    <div class="">
                        {% if bot is empty %}
                            <div class="">
                                Данных нет
                            </div>
                        {% else %}
                            <div class="">
                                <div class="">Название бота: {{ bot.botName }}</div>
                                <div class="">
                                    <section>
                                        <span>Проект:</span> {{ bot.projectName }}
                                    </section>
                                    <section>
                                        <span>Состояние:</span>
                                        {% if bot.botActive is not empty %}
                                            <span class="">Активен</span>
                                        {% else %}
                                            <span class="">Не активен</span>
                                        {% endif %}
                                    </section>
                                    <section>
                                        <span>Тип:</span> {{ bot.botType }}
                                    </section>
                                    <section>
                                        <span>Токен:</span> {{ bot.botToken }}
                                    </section>
                                    <section>
                                        <span>Вебхук:</span> {{ bot.webhookUri }}
                                    </section>
                                </div>

                                <hr>

                                <div class="">

                                    {% if bot.webhookInfo.pendingUpdateCount is not null %}
                                        <section>
                                            <span>Количество обновлений, ожидающих доставки:</span> {{ bot.webhookInfo.pendingUpdateCount }}
                                        </section>
                                    {% endif %}

                                    {% if bot.webhookInfo.lastErrorDate is not null %}
                                        <section class="">
                                            <span>Дата ошибки:</span> {{ bot.webhookInfo.lastErrorDate }}
                                        </section>
                                    {% endif %}

                                    {% if bot.webhookInfo.lastErrorMessage is not null %}
                                        <section class="">
                                            <span>Сообщение об ошибки:</span> {{ bot.webhookInfo.lastErrorMessage }}
                                        </section>
                                    {% endif %}
                                </div>

                                <hr>

                                <div class="">
                                    <div class="admin--title--wrapper">
                                        <h4>Действия</h4>
                                    </div>

                                    <div style="display: flex; flex-wrap: wrap;">
                                        <button type="button" class="btn btn-success admin--btn-left"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editWebhook">Установить вебхук
                                        </button>

                                        {% if bot.botActive is not empty %}
                                            <section>
                                                <a class="btn btn-danger admin--btn-left"
                                                   href="/dev/project/{{ bot.projectId }}/bot/{{ bot.botId }}/deactivate/">Отключить
                                                    бота</a>
                                            </section>
                                        {% else %}
                                            <section>
                                                <a class="btn btn-success admin--btn-left"
                                                   href="/dev/project/{{ bot.projectId }}/bot/{{ bot.botId }}/activate/">Включить
                                                    бота</a>
                                            </section>
                                        {% endif %}

                                        <button type="button" class="btn btn-success admin--btn-left"
                                                data-bs-toggle="modal"
                                                data-bs-target="#sendMessage">
                                            Отправить сообщение
                                        </button>
                                    </div>

                                    <!-- MODAL -- Установить фебхук -->
                                    <div class="modal fade" id="editWebhook" data-bs-keyboard="false" tabindex="-1"
                                         aria-labelledby="editWebhookLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editWebhookLabel">Modal title</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                </div>

                                                <div class="modal-body">
                                                    <form action="/dev/project/{{ bot.projectId }}/bot/{{ bot.botId }}/webhook/activate/"
                                                          method="POST">
                                                        <div class="mb-3">
                                                            <label for="webhook" class="col-form-label">Ссылка:</label>
                                                            <input type="text" class="form-control" name="webhook"
                                                                   placeholder="Установить фебхук" id="webhook">
                                                        </div>
                                                    </form>
                                                </div>

                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">Close
                                                    </button>
                                                    <button type="button" class="btn btn-primary">Сохранить</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- MODAL -- Установить фебхук -->

                                    <!-- MODAL -- Отправить новое сообщение -->
                                    <div class="modal fade" id="sendMessage" data-bs-keyboard="false" tabindex="-1"
                                         aria-labelledby="sendMessageLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="sendMessageLabel">Modal title</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                </div>

                                                <div class="modal-body">
                                                    <form action="/dev/project/{{ bot.projectId }}/bot/{{ bot.botId }}/fake_message/"
                                                          method="POST">
                                                        <div class="mb-3">
                                                            <label for="message" class="col-form-label">Текст
                                                                сообщения:</label>
                                                            <textarea class="form-control" id="message" name="message"
                                                                      placeholder="Текст сообщения"></textarea>
                                                        </div>
                                                        <button class="btn btn-primary">Отправить</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- MODAL -- Отправить новое сообщение -->
                                </div>

                                <hr>

                                <div class="admin--title--wrapper">
                                    <h4>Сценарии</h4>
                                </div>


                                <form method="POST"
                                      action="/dev/project/{{ projectId }}/bot/{{ bot.botId }}/apply-scenario/"
                                        {#                                        action="/dev/project/{{ projectId }}/scenario/{{ scenarioItem.id }}/apply/" #}
                                >
                                    <div class="mb-3">
                                        <label for="scenario" class="col-form-label">Установить сценарий:</label>
                                        <select class="form-select" name="scenario" id="scenario">
                                            {% for scenarioItem in scenarios %}
                                                <option value="{{ scenarioItem.id }}">{{ scenarioItem.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <button class="btn btn-primary">Установить</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-5">
                <div class="wrapper--block">
                    <div class="admin--title--wrapper">
                        <h2>Сессии</h2>
                    </div>

                    <div class="">
                        {% if sessions is empty %}
                            <div class="">
                                Данных нет
                            </div>
                        {% endif %}

                        {% for session in sessions %}
                            <hr>

                            <div class="">
                                <div class="">
                                    <a href="/admin/projects/{{ projectId }}/sessions/{{ session.id }}/" target="_blank">
                                        <div class="admin--title--wrapper">
                                            <h4>{{ session.sessionName }}</h4>
                                        </div>
                                    </a>

                                    <section>
                                        <span>Канал:</span> {{ session.sessionChannel }}
                                    </section>
                                    <section>
                                        <span>Контент:</span> {{ session.cache.content }}
                                    </section>

                                    {% if session.sessionVisitorEvent is defined %}
                                        <section>
                                            <span>Тип события:</span> {{ session.sessionVisitorEvent.type }}
                                        </section>
                                        <section>
                                            <span>Статус последнего события:</span> {{ session.sessionVisitorEvent.status }}
                                        </section>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>


    {#        <div class="jj__main_wrapper jj__main_wrapper--line"> #}
    {#            <div class="jj__wrapper jj__wrapper-50"> #}
    {#                <div class="jj__h"> #}
    {#                    <h2>Сценарии</h2> #}
    {#                </div> #}

    {#                <div class="jj__items"> #}
    {#                    {% if scenarios is empty %} #}
    {#                        <div class="jj__items-without-data"> #}
    {#                            Данных нет #}
    {#                        </div> #}
    {#                    {% endif %} #}

    {#                    {% for scenarioItem in scenarios %} #}
    {#                        <div class="jj__item"> #}
    {#                            <div class="jj__item_name">Сценарий #{{ scenarioItem.id }}</div> #}

    {#                            <div class="jj__item_data jj__item_data--line"> #}
    {#                                <section> #}
    {#                                    <span>Название:</span> {{ scenarioItem.name }} #}
    {#                                </section> #}
    {#                            </div> #}

    {#                            <div class="jj__item_data jj__item_data--line"> #}
    {#                                <section> #}
    {#                                    <form action="/dev/project/{{ projectId }}/scenario/{{ scenarioItem.id }}/apply/" #}
    {#                                          method="GET"> #}
    {#                                        <label> #}
    {#                                            Подключить бот: #}
    {#                                            <select name="botId"> #}
    {#                                                {% for bot in bots %} #}
    {#                                                    <option value="{{ bot.botId }}">{{ bot.botName }}</option> #}
    {#                                                {% endfor %} #}
    {#                                            </select> #}
    {#                                            к сценарию #}
    {#                                        </label> #}

    {#                                        <button> #}
    {#                                            Подключить #}
    {#                                        </button> #}
    {#                                    </form> #}
    {#                                </section> #}
    {#                            </div> #}
    {#                        </div> #}
    {#                    {% endfor %} #}
    {#                </div> #}
    {#            </div> #}
    {#        </div> #}

{% endblock %}
